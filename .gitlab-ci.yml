image: python:3.12-slim

stages:
  - build
  - deploy

pages:
  stage: build
  script:
    - pip install --no-cache-dir -r requirements.txt
    - mkdocs build -d public
  artifacts:
    paths:
      - public
  only:
    - main

deploy_polairs:
  stage: deploy
  image: alpine:latest
  needs: ["build"]
  before_script:
    - apk add --no-cache openssh-client rsync
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
  script:
    - rsync -avz --delete public/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"
  only:
    - main
